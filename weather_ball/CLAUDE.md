# 天气水晶球项目 - 优化计划

## 项目概述
基于 Three.js 的 3D 天气可视化项目，目标实现如参考图所示的高质量天气水晶球效果。

## 当前状态分析

### 已有功能
- ✅ Three.js + WebGL 基础渲染框架
- ✅ 多系统架构（光照、大气、云层、粒子、动画系统）
- ✅ Sky HDRI 环境系统 + PMREM 环境贴图
- ✅ HTML 控制界面
- ✅ 基础玻璃材质（MeshPhysicalMaterial）

### 核心问题
- ❌ 玻璃球过于透明（opacity: 0.3），视觉效果微弱
- ❌ 缺少内部天气内容可视化层
- ❌ 没有体积渲染效果
- ❌ 光学效果（折射、反射、焦散）不够强烈

## 参考效果分析

根据 `ref/` 目录下的3张参考图：

### 视觉目标
1. **透明玻璃球壳**：边缘强反射（Fresnel效应）
2. **内部天气内容物**：
   - 蓝色漩涡云层（晴天/多云）
   - 暖色调 + 水滴效果（雨天）
   - 体积感的气象现象
3. **真实光学效果**：折射、反射、彩虹边缘、底部焦散阴影
4. **表面细节**：水滴、高光、材质质感

## 技术实现方案

### 核心架构：双层球体结构

```
外层玻璃球壳（透明）
├── 强Fresnel反射
├── 折射效果
├── 表面水滴纹理
└── 彩虹色散边缘

内层天气内容球（半透明）
├── 体积云层着色器
├── 漩涡动画
├── 粒子系统（雨滴/雪花/气泡）
└── 天气色彩映射
```

## 分阶段实施计划

### Phase 1: 双层球体基础结构
**目标**: 解决基础可见性问题
- [ ] 创建外层玻璃球壳（透明度调整）
- [ ] 创建内层内容球（半透明背景）
- [ ] 优化 Fresnel 反射效果
- [ ] 强化边缘高光

**技术要点**:
- 外层：`opacity: 0.1-0.15`, `transmission: 0.9`, 强 `clearcoat`
- 内层：体积渲染基础，颜色根据天气变化
- 双面渲染避免内外层冲突

### Phase 2: 内部云层体积渲染
**目标**: 实现漩涡云层效果
- [ ] 编写体积云层着色器（Vertex + Fragment）
- [ ] 实现噪声函数（Perlin/Simplex noise）
- [ ] 添加漩涡动画（旋转 + 扰动）
- [ ] 天气状态色彩映射

**技术要点**:
- 3D noise 纹理生成
- 时间动画驱动
- 密度变化模拟不同天气
- 色彩插值（蓝色→暖色→灰色等）

### Phase 3: 粒子系统升级
**目标**: 内部漂浮粒子效果
- [ ] 球体内部约束的粒子系统
- [ ] 水滴/雪花/气泡几何体
- [ ] 物理模拟（重力、浮力、风力）
- [ ] 粒子与云层交互

**技术要点**:
- GPU 粒子系统（instanced rendering）
- 球形边界约束
- 不同天气的粒子类型切换
- 透明度排序

### Phase 4: 光学效果强化
**目标**: 达到参考图的光学质感
- [ ] 真实折射效果（环境贴图扭曲）
- [ ] 底部焦散阴影
- [ ] 彩虹色散边缘
- [ ] 表面水滴/气泡纹理

**技术要点**:
- 自定义 refraction shader
- 焦散光影计算
- 色散效果（chromatic aberration）
- 程序化表面细节纹理

### Phase 5: 动画和交互优化
**目标**: 流畅的天气转换和用户体验
- [ ] 天气状态间的平滑过渡
- [ ] 鼠标交互（悬停高亮、拖拽旋转）
- [ ] 性能优化（LOD、frustum culling）
- [ ] 移动端适配

## 技术需求和约束

### 性能目标
- 桌面端：60 FPS
- 移动端：30 FPS（自动降级）
- 包体积：≤ 2MB

### 渲染技术栈
- **核心**: Three.js r158
- **着色器**: GLSL ES 3.0
- **纹理**: 程序化生成 + 压缩格式
- **环境**: HDRI (PMREM) + Sky shader

### 兼容性
- WebGL 2.0 优先，降级到 WebGL 1.0
- Chrome 90+, Firefox 88+, Safari 14+
- 移动端 iOS Safari 14+, Chrome Mobile 90+

## 开发规范

### 代码组织
```
src/
├── weather-ball.js           # 主类
├── systems/                  # 各子系统
│   ├── lighting-system.js
│   ├── atmosphere-system.js
│   ├── cloud-system.js      # 重点升级
│   ├── particle-system.js   # 重点升级
│   └── glass-system.js      # 新增：玻璃效果
├── shaders/                  # 着色器代码
│   ├── volume-cloud.vert
│   ├── volume-cloud.frag
│   ├── glass-refraction.vert
│   └── glass-refraction.frag
└── utils/
    ├── noise-generator.js    # 噪声工具
    └── weather-mapper.js     # 天气映射
```

### 质量标准
- **可视性**: 效果必须明显可见，不能过于微妙
- **真实感**: 光学效果符合物理规律
- **流畅性**: 动画过渡自然，无闪烁跳跃
- **响应性**: 参数调整实时反馈

### 调试工具
- 材质参数实时调节面板
- 性能监控 (FPS, draw calls)
- 着色器错误检查
- 移动端测试模式

## 里程碑检查点

### Phase 1 完成标准
- 双层球体清晰可见
- 外层反射效果明显
- 内层颜色可以根据天气变化

### Phase 2 完成标准
- 内部云层漩涡动画流畅
- 不同天气状态视觉差异明显
- 体积感充足

### Phase 3 完成标准
- 粒子效果自然真实
- 与云层结合无违和感
- 不同天气粒子类型正确

### Phase 4 完成标准
- 整体效果接近参考图质量
- 光学效果逼真
- 细节丰富

### Phase 5 完成标准
- 用户交互流畅
- 性能达标
- 跨设备兼容

## 风险评估

### 技术风险
- **着色器复杂度**: 体积渲染可能影响性能
- **透明度排序**: 双层结构可能出现渲染顺序问题
- **移动端兼容**: 复杂效果在低端设备上的表现

### 缓解策略
- 提供多级质量设置（高/中/低）
- 关键路径的降级方案
- 充分的跨设备测试

## 预期成果

最终实现一个高质量的天气水晶球，具备：
- 📸 **视觉冲击力**: 接近参考图的效果质量
- 🎮 **交互体验**: 直观的天气状态切换
- 🚀 **性能优秀**: 流畅运行在目标设备上
- 🔧 **可扩展性**: 易于添加新的天气效果

---

*最后更新: 2025-08-24*
*项目状态: Phase 1 准备中*