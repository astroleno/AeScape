<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AeScape 优化功能测试</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    
    .test-section {
      margin: 30px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
    }
    
    .test-button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
    }
    
    .test-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .test-result {
      margin: 10px 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
    }
    
    .success { border-left: 4px solid #4CAF50; }
    .error { border-left: 4px solid #f44336; }
    .warning { border-left: 4px solid #ff9800; }
    .info { border-left: 4px solid #2196F3; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>🚀 AeScape 优化功能测试</h1>
    <p>此页面用于测试新增的优化模块是否正常工作</p>
    
    <!-- 错误处理器测试 -->
    <div class="test-section">
      <h2>🛡️ 错误处理器测试</h2>
      <button class="test-button" onclick="testErrorHandler()">测试错误处理</button>
      <button class="test-button" onclick="testCriticalError()">测试关键错误</button>
      <div id="error-handler-result" class="test-result"></div>
    </div>
    
    <!-- 性能监控器测试 -->
    <div class="test-section">
      <h2>📊 性能监控器测试</h2>
      <button class="test-button" onclick="testPerformanceMonitor()">测试性能监控</button>
      <button class="test-button" onclick="showPerformanceStats()">显示性能统计</button>
      <div id="performance-result" class="test-result"></div>
    </div>
    
    <!-- 配置管理器测试 -->
    <div class="test-section">
      <h2>⚙️ 配置管理器测试</h2>
      <button class="test-button" onclick="testConfigManager()">测试配置管理</button>
      <button class="test-button" onclick="testConfigValidation()">测试配置验证</button>
      <div id="config-result" class="test-result"></div>
    </div>
    
    <!-- 视频资源管理器测试 -->
    <div class="test-section">
      <h2>🎬 视频资源管理器测试</h2>
      <button class="test-button" onclick="testVideoResourceManager()">测试视频缓存</button>
      <button class="test-button" onclick="showVideoStats()">显示缓存统计</button>
      <div id="video-resource-result" class="test-result"></div>
    </div>
    
    <!-- 智能主题适配器测试 -->
    <div class="test-section">
      <h2>🎨 智能主题适配器测试</h2>
      <button class="test-button" onclick="testThemeAdapter()">测试主题缓存</button>
      <button class="test-button" onclick="testThemeTransition()">测试主题切换</button>
      <div id="theme-adapter-result" class="test-result"></div>
    </div>
    
    <!-- 整体集成测试 -->
    <div class="test-section">
      <h2>🔄 整体集成测试</h2>
      <button class="test-button" onclick="runFullTest()">运行完整测试</button>
      <div id="integration-result" class="test-result"></div>
    </div>
  </div>

  <!-- 加载优化模块 -->
  <script src="js/ErrorHandler.js"></script>
  <script src="js/PerformanceMonitor.js"></script>
  <script src="js/ConfigManager.js"></script>
  <script src="js/VideoResourceManager.js"></script>
  <script src="js/SmartThemeAdapter.js"></script>

  <script>
    // 全局测试实例
    let errorHandler, performanceMonitor, configManager, videoResourceManager, smartThemeAdapter;
    
    // 初始化测试环境
    async function initTestEnvironment() {
      try {
        errorHandler = new AeScapeErrorHandler();
        performanceMonitor = new AeScapePerformanceMonitor();
        configManager = new AeScapeConfigManager();
        videoResourceManager = new VideoResourceManager();
        smartThemeAdapter = new SmartThemeAdapter({ debugMode: true });
        
        console.log('测试环境初始化完成');
      } catch (error) {
        console.error('测试环境初始化失败:', error);
      }
    }
    
    // 错误处理器测试
    function testErrorHandler() {
      const resultDiv = document.getElementById('error-handler-result');
      try {
        // 测试普通错误处理
        const testError = new Error('这是一个测试错误');
        const errorInfo = errorHandler.handleError(testError, 'TestContext', { severity: 'warning' });
        
        resultDiv.innerHTML = `
          <div class="success">✅ 错误处理器测试通过</div>
          <div class="info">错误ID: ${errorInfo.timestamp}</div>
          <div class="info">上下文: ${errorInfo.context}</div>
        `;
        resultDiv.className = 'test-result success';
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">❌ 错误处理器测试失败: ${error.message}</div>`;
        resultDiv.className = 'test-result error';
      }
    }
    
    function testCriticalError() {
      const resultDiv = document.getElementById('error-handler-result');
      try {
        const criticalError = new Error('关键系统错误');
        errorHandler.handleError(criticalError, 'CriticalSystem', { 
          severity: 'critical',
          showNotification: true 
        });
        
        resultDiv.innerHTML += `<div class="warning">⚠️ 关键错误处理测试完成</div>`;
      } catch (error) {
        resultDiv.innerHTML += `<div class="error">❌ 关键错误测试失败: ${error.message}</div>`;
      }
    }
    
    // 性能监控器测试
    function testPerformanceMonitor() {
      const resultDiv = document.getElementById('performance-result');
      try {
        // 记录一些测试指标
        performanceMonitor.recordLoadTime('TestComponent', Date.now() - 1000, Date.now());
        performanceMonitor.recordApiResponse('TestAPI', 150);
        
        resultDiv.innerHTML = `
          <div class="success">✅ 性能监控器测试通过</div>
          <div class="info">已记录测试性能数据</div>
        `;
        resultDiv.className = 'test-result success';
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">❌ 性能监控器测试失败: ${error.message}</div>`;
        resultDiv.className = 'test-result error';
      }
    }
    
    function showPerformanceStats() {
      const resultDiv = document.getElementById('performance-result');
      try {
        const stats = performanceMonitor.getPerformanceReport();
        resultDiv.innerHTML += `
          <div class="info">📊 性能统计报告:</div>
          <pre>${JSON.stringify(stats, null, 2)}</pre>
        `;
      } catch (error) {
        resultDiv.innerHTML += `<div class="error">❌ 获取性能统计失败: ${error.message}</div>`;
      }
    }
    
    // 配置管理器测试
    async function testConfigManager() {
      const resultDiv = document.getElementById('config-result');
      try {
        // 测试配置读写
        await configManager.setConfig('test.value', 'hello world');
        const value = configManager.getConfig('test.value');
        
        if (value === 'hello world') {
          resultDiv.innerHTML = `
            <div class="success">✅ 配置管理器测试通过</div>
            <div class="info">配置读写功能正常</div>
          `;
          resultDiv.className = 'test-result success';
        } else {
          throw new Error('配置值不匹配');
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">❌ 配置管理器测试失败: ${error.message}</div>`;
        resultDiv.className = 'test-result error';
      }
    }
    
    async function testConfigValidation() {
      const resultDiv = document.getElementById('config-result');
      try {
        // 测试配置验证
        const isValid = configManager.validateConfig({
          video: { enabled: true, maxCacheSize: 3 },
          theme: { autoUpdate: true }
        });
        
        resultDiv.innerHTML += `
          <div class="info">🔍 配置验证结果: ${isValid ? '通过' : '失败'}</div>
        `;
      } catch (error) {
        resultDiv.innerHTML += `<div class="error">❌ 配置验证测试失败: ${error.message}</div>`;
      }
    }
    
    // 视频资源管理器测试
    async function testVideoResourceManager() {
      const resultDiv = document.getElementById('video-resource-result');
      try {
        // 创建一个测试视频元素
        const testVideo = document.createElement('video');
        testVideo.src = 'data:video/mp4;base64,AAAAHGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXQBAAAbBmiAhvbBBgAACjQBAAAK';
        
        // 测试缓存功能
        videoResourceManager.addToCache('test-video', testVideo, { type: 'test' });
        const cached = videoResourceManager.getCachedVideo('test-video');
        
        if (cached) {
          resultDiv.innerHTML = `
            <div class="success">✅ 视频资源管理器测试通过</div>
            <div class="info">视频缓存功能正常</div>
          `;
          resultDiv.className = 'test-result success';
        } else {
          throw new Error('视频缓存失败');
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">❌ 视频资源管理器测试失败: ${error.message}</div>`;
        resultDiv.className = 'test-result error';
      }
    }
    
    function showVideoStats() {
      const resultDiv = document.getElementById('video-resource-result');
      try {
        const stats = videoResourceManager.getPerformanceMetrics();
        resultDiv.innerHTML += `
          <div class="info">📹 视频缓存统计:</div>
          <pre>${JSON.stringify(stats, null, 2)}</pre>
        `;
      } catch (error) {
        resultDiv.innerHTML += `<div class="error">❌ 获取视频统计失败: ${error.message}</div>`;
      }
    }
    
    // 智能主题适配器测试
    async function testThemeAdapter() {
      const resultDiv = document.getElementById('theme-adapter-result');
      try {
        const testTheme = {
          primaryColor: '#667eea',
          backgroundColor: '#764ba2',
          textColor: '#ffffff',
          isNight: false
        };
        
        const testElement = document.createElement('div');
        await smartThemeAdapter.applyTheme(testTheme, [testElement]);
        
        resultDiv.innerHTML = `
          <div class="success">✅ 智能主题适配器测试通过</div>
          <div class="info">主题应用功能正常</div>
        `;
        resultDiv.className = 'test-result success';
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">❌ 智能主题适配器测试失败: ${error.message}</div>`;
        resultDiv.className = 'test-result error';
      }
    }
    
    async function testThemeTransition() {
      const resultDiv = document.getElementById('theme-adapter-result');
      try {
        const stats = smartThemeAdapter.getStats();
        resultDiv.innerHTML += `
          <div class="info">🎨 主题适配器统计:</div>
          <pre>${JSON.stringify(stats, null, 2)}</pre>
        `;
      } catch (error) {
        resultDiv.innerHTML += `<div class="error">❌ 获取主题统计失败: ${error.message}</div>`;
      }
    }
    
    // 运行完整测试
    async function runFullTest() {
      const resultDiv = document.getElementById('integration-result');
      resultDiv.innerHTML = '<div class="info">🔄 正在运行完整测试...</div>';
      
      let passedTests = 0;
      let totalTests = 5;
      
      try {
        // 测试所有模块
        await testErrorHandler();
        passedTests++;
        
        await testPerformanceMonitor();
        passedTests++;
        
        await testConfigManager();
        passedTests++;
        
        await testVideoResourceManager();
        passedTests++;
        
        await testThemeAdapter();
        passedTests++;
        
        resultDiv.innerHTML = `
          <div class="success">🎉 完整测试完成</div>
          <div class="info">通过测试: ${passedTests}/${totalTests}</div>
          <div class="info">所有优化模块运行正常</div>
        `;
        resultDiv.className = 'test-result success';
        
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">❌ 完整测试失败</div>
          <div class="error">通过测试: ${passedTests}/${totalTests}</div>
          <div class="error">错误: ${error.message}</div>
        `;
        resultDiv.className = 'test-result error';
      }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      initTestEnvironment();
      console.log('AeScape 优化功能测试页面已加载');
    });
  </script>
</body>
</html>
