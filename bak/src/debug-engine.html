<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¤©æ°”å¼•æ“é—®é¢˜è¯Šæ–­</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    .test-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      position: relative;
      z-index: 10;
    }
    #weather-container {
      width: 600px;
      height: 400px;
      border: 2px solid #ccc;
      margin: 20px 0;
      border-radius: 8px;
      background: #000;
      position: relative;
      z-index: 1;
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .test-button:hover {
      background: #0056b3;
    }
    #console-output {
      background: #1e1e1e;
      color: #fff;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .slider-test {
      margin: 10px 0;
    }
    .slider-test input[type="range"] {
      width: 300px;
    }
  </style>
</head>
<body>
  <h1>ğŸ” å¤©æ°”å¼•æ“é—®é¢˜è¯Šæ–­</h1>
  
  <div class="test-container">
    <h2>åŸºç¡€æµ‹è¯•</h2>
    <button class="test-button" onclick="testEngineCreation()">æµ‹è¯•å¼•æ“åˆ›å»º</button>
    <button class="test-button" onclick="testEngineInitialization()">æµ‹è¯•å¼•æ“åˆå§‹åŒ–</button>
    <button class="test-button" onclick="testControlParams()">æµ‹è¯•æ§åˆ¶å‚æ•°</button>
    <button class="test-button" onclick="testMethods()">æµ‹è¯•æ–¹æ³•å¯ç”¨æ€§</button>
    <button class="test-button" onclick="clearConsole()">æ¸…é™¤è¾“å‡º</button>
  </div>
  
  <div id="weather-container"></div>
  
  <div class="test-container">
    <h2>äº‹ä»¶ç»‘å®šæµ‹è¯•</h2>
    <div class="slider-test">
      <label>æµ‹è¯•æ»‘åŠ¨æ¡:</label>
      <input type="range" id="test-slider" min="0" max="100" value="50">
      <span id="test-slider-value">50</span>
    </div>
    <button class="test-button" onclick="testEventBinding()">æµ‹è¯•äº‹ä»¶ç»‘å®š</button>
    <button class="test-button" onclick="testDirectMethodCall()">æµ‹è¯•ç›´æ¥æ–¹æ³•è°ƒç”¨</button>
  </div>
  
  <div class="test-container">
    <h2>å®Œæ•´æ»‘åŠ¨æ¡æµ‹è¯•</h2>
    <div class="slider-test">
      <label>å¤ªé˜³é«˜åº¦è§’:</label>
      <input type="range" id="sun-altitude" min="-90" max="90" value="30">
      <span id="sun-altitude-value">30</span>
    </div>
    <button class="test-button" onclick="testRealSlider()">æµ‹è¯•çœŸå®æ»‘åŠ¨æ¡</button>
  </div>
  
  <div id="console-output">ç­‰å¾…æµ‹è¯•...</div>
  
  <script src="../three.min.js"></script>
  <script src="full-weather-engine.js"></script>
  <script>
    let weatherEngine = null;
    const consoleOutput = document.getElementById('console-output');
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      consoleOutput.textContent += `[${timestamp}] ${message}\n`;
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      console.log(message);
    }
    
    function clearConsole() {
      consoleOutput.textContent = '';
    }
    
    function testEngineCreation() {
      clearConsole();
      log('=== æµ‹è¯•å¼•æ“åˆ›å»º ===');
      
      try {
        const container = document.getElementById('weather-container');
        weatherEngine = new FullWeatherEngine(container);
        log('âœ… å¼•æ“å®ä¾‹åˆ›å»ºæˆåŠŸ');
        log(`å¼•æ“ç±»å‹: ${typeof weatherEngine}`);
        log(`å¼•æ“å¯¹è±¡: ${weatherEngine}`);
        log(`åˆå§‹åŒ–Promise: ${weatherEngine.initializationPromise}`);
      } catch (error) {
        log(`âŒ å¼•æ“åˆ›å»ºå¤±è´¥: ${error.message}`);
        console.error(error);
      }
    }
    
    async function testEngineInitialization() {
      clearConsole();
      log('=== æµ‹è¯•å¼•æ“åˆå§‹åŒ– ===');
      
      if (!weatherEngine) {
        log('âŒ è¯·å…ˆåˆ›å»ºå¼•æ“');
        return;
      }
      
      try {
        log('ç­‰å¾…åˆå§‹åŒ–å®Œæˆ...');
        await weatherEngine.initializationPromise;
        log('âœ… å¼•æ“åˆå§‹åŒ–å®Œæˆ');
        
        // æ£€æŸ¥æ ¸å¿ƒå¯¹è±¡
        log('æ ¸å¿ƒå¯¹è±¡çŠ¶æ€:');
        log(`  åœºæ™¯: ${!!weatherEngine.scene}`);
        log(`  ç›¸æœº: ${!!weatherEngine.camera}`);
        log(`  æ¸²æŸ“å™¨: ${!!weatherEngine.renderer}`);
        log(`  åˆæˆå™¨: ${!!weatherEngine.composer}`);
        
      } catch (error) {
        log(`âŒ å¼•æ“åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
        console.error(error);
      }
    }
    
    function testControlParams() {
      clearConsole();
      log('=== æµ‹è¯•æ§åˆ¶å‚æ•° ===');
      
      if (!weatherEngine) {
        log('âŒ è¯·å…ˆåˆ›å»ºå¼•æ“');
        return;
      }
      
      log(`æ§åˆ¶å‚æ•°å¯¹è±¡: ${weatherEngine.controlParams}`);
      log(`æ§åˆ¶å‚æ•°ç±»å‹: ${typeof weatherEngine.controlParams}`);
      
      if (weatherEngine.controlParams) {
        log('æ§åˆ¶å‚æ•°å†…å®¹:');
        Object.keys(weatherEngine.controlParams).forEach(key => {
          log(`  ${key}: ${weatherEngine.controlParams[key]}`);
        });
      } else {
        log('âŒ æ§åˆ¶å‚æ•°ä¸å­˜åœ¨');
      }
    }
    
    function testMethods() {
      clearConsole();
      log('=== æµ‹è¯•æ–¹æ³•å¯ç”¨æ€§ ===');
      
      if (!weatherEngine) {
        log('âŒ è¯·å…ˆåˆ›å»ºå¼•æ“');
        return;
      }
      
      const methods = [
        'applyControlParams',
        'updateSunPosition',
        'updateWeatherType',
        'calculateSunPositionFromTime',
        'resetControlParams'
      ];
      
      methods.forEach(method => {
        const exists = typeof weatherEngine[method] === 'function';
        log(`  ${method}: ${exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}`);
        if (exists) {
          log(`    ç±»å‹: ${typeof weatherEngine[method]}`);
        }
      });
    }
    
    function testEventBinding() {
      clearConsole();
      log('=== æµ‹è¯•äº‹ä»¶ç»‘å®š ===');
      
      const slider = document.getElementById('test-slider');
      const valueDisplay = document.getElementById('test-slider-value');
      
      // æµ‹è¯•åŸºç¡€äº‹ä»¶ç»‘å®š
      slider.oninput = function() {
        const value = this.value;
        valueDisplay.textContent = value;
        log(`åŸºç¡€äº‹ä»¶è§¦å‘: ${value}`);
      };
      
      log('âœ… åŸºç¡€äº‹ä»¶ç»‘å®šå®Œæˆ');
      log('è¯·æ‹–åŠ¨æµ‹è¯•æ»‘åŠ¨æ¡');
    }
    
    function testDirectMethodCall() {
      clearConsole();
      log('=== æµ‹è¯•ç›´æ¥æ–¹æ³•è°ƒç”¨ ===');
      
      if (!weatherEngine || !weatherEngine.controlParams) {
        log('âŒ å¼•æ“æˆ–æ§åˆ¶å‚æ•°ä¸å¯ç”¨');
        return;
      }
      
      try {
        // æµ‹è¯•ç›´æ¥ä¿®æ”¹å‚æ•°
        const originalValue = weatherEngine.controlParams.sunAltitude;
        weatherEngine.controlParams.sunAltitude = 60;
        log(`å‚æ•°ä¿®æ”¹: ${originalValue} â†’ ${weatherEngine.controlParams.sunAltitude}`);
        
        // æµ‹è¯•æ–¹æ³•è°ƒç”¨
        if (weatherEngine.updateSunPosition) {
          log('è°ƒç”¨ updateSunPosition...');
          weatherEngine.updateSunPosition();
          log('âœ… updateSunPosition è°ƒç”¨æˆåŠŸ');
        }
        
        if (weatherEngine.applyControlParams) {
          log('è°ƒç”¨ applyControlParams...');
          weatherEngine.applyControlParams();
          log('âœ… applyControlParams è°ƒç”¨æˆåŠŸ');
        }
        
      } catch (error) {
        log(`âŒ æ–¹æ³•è°ƒç”¨å¤±è´¥: ${error.message}`);
        console.error(error);
      }
    }
    
    function testRealSlider() {
      clearConsole();
      log('=== æµ‹è¯•çœŸå®æ»‘åŠ¨æ¡ ===');
      
      if (!weatherEngine || !weatherEngine.controlParams) {
        log('âŒ å¼•æ“æˆ–æ§åˆ¶å‚æ•°ä¸å¯ç”¨');
        return;
      }
      
      const slider = document.getElementById('sun-altitude');
      const valueDisplay = document.getElementById('sun-altitude-value');
      
      log('è®¾ç½®çœŸå®æ»‘åŠ¨æ¡äº‹ä»¶...');
      
      slider.oninput = function() {
        const value = parseFloat(this.value);
        valueDisplay.textContent = value;
        
        log(`æ»‘åŠ¨æ¡å˜åŒ–: ${value}`);
        
        try {
          // ç›´æ¥ä¿®æ”¹å¼•æ“å‚æ•°
          weatherEngine.controlParams.sunAltitude = value;
          log(`å‚æ•°å·²è®¾ç½®ä¸º: ${weatherEngine.controlParams.sunAltitude}`);
          
          // è°ƒç”¨æ›´æ–°æ–¹æ³•
          if (weatherEngine.updateSunPosition) {
            weatherEngine.updateSunPosition();
            log('âœ… updateSunPosition è°ƒç”¨æˆåŠŸ');
          }
          
          if (weatherEngine.applyControlParams) {
            weatherEngine.applyControlParams();
            log('âœ… applyControlParams è°ƒç”¨æˆåŠŸ');
          }
          
        } catch (error) {
          log(`âŒ æ»‘åŠ¨æ¡å¤„ç†å¤±è´¥: ${error.message}`);
          console.error(error);
        }
      };
      
      log('âœ… çœŸå®æ»‘åŠ¨æ¡äº‹ä»¶ç»‘å®šå®Œæˆ');
      log('è¯·æ‹–åŠ¨å¤ªé˜³é«˜åº¦è§’æ»‘åŠ¨æ¡æµ‹è¯•');
    }
    
    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('load', () => {
      log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·æŒ‰é¡ºåºæµ‹è¯•');
      log('1. æµ‹è¯•å¼•æ“åˆ›å»º');
      log('2. æµ‹è¯•å¼•æ“åˆå§‹åŒ–');
      log('3. æµ‹è¯•æ§åˆ¶å‚æ•°');
      log('4. æµ‹è¯•æ–¹æ³•å¯ç”¨æ€§');
    });
  </script>
</body>
</html>