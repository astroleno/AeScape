<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A/Bå¯¹ç…§æµ‹è¯• - å¤©æ°”å¼•æ“</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #1a1a1a;
      color: white;
    }
    #test-container {
      width: 100%;
      height: 600px; /* å¢åŠ é«˜åº¦ä»¥è·å¾—æ›´å¥½çš„é•¿ç„¦æ•ˆæœ */
      border: 2px solid #4CAF50;
      border-radius: 10px;
      margin: 20px 0;
      position: relative;
    }
    .controls {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .control-row {
      display: flex;
      gap: 15px;
      margin: 10px 0;
    }
    .control-group {
      flex: 1;
      margin: 0;
      padding: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
    }
    .control-group h3, .control-group h4 {
      margin: 0 0 8px 0;
      color: #4CAF50;
      font-size: 14px;
    }
    .slider-container {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }
    .slider-container label {
      min-width: 120px;
      font-size: 14px;
    }
    .slider {
      flex: 1;
      margin: 0 10px;
    }
    .value-display {
      min-width: 60px;
      font-size: 12px;
      color: #ccc;
    }
    .btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background: #45a049;
    }
    .btn.active {
      background: #ff9800;
    }
    .btn-group {
      margin: 10px 0;
    }
    .preset-btn {
      background: #2196F3;
      margin: 3px;
      padding: 6px 12px;
      font-size: 12px;
    }
    .preset-btn:hover {
      background: #1976D2;
    }
    .log {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      height: 200px;
      overflow-y: auto;
      margin: 10px 0;
    }
    .status {
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 14px;
    }
    .status-item {
      margin: 5px 0;
    }
    .status-label {
      color: #4CAF50;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸ”¬ A/Bå¯¹ç…§æµ‹è¯• - å¤©æ°”å¼•æ“</h1>
  
  <div id="test-container"></div>
  
  <div class="controls">
    <h3>ğŸ¯ å¿«é€Ÿé¢„è®¾ï¼ˆweatheradvice.mdå»ºè®®ï¼‰</h3>
    <div class="btn-group">
      <button class="btn preset-btn" onclick="applyPreset('ios-clear')">iOSæ™´å¤©</button>
      <button class="btn preset-btn" onclick="applyPreset('ios-cloudy')">iOSå¤šäº‘</button>
      <button class="btn preset-btn" onclick="applyPreset('ios-rain')">iOSé›¨å¤©</button>
      <button class="btn preset-btn" onclick="applyPreset('ios-snow')">iOSé›ªå¤©</button>
      <button class="btn preset-btn" onclick="applyPreset('low-fog')">ä½é›¾å¯¹æ¯”</button>
      <button class="btn preset-btn" onclick="applyPreset('high-detail')">é«˜ç»†èŠ‚</button>
    </div>
    
    <h3>ğŸ”¬ è¾¹ç¼˜å‡è±¡éªŒè¯æµ‹è¯•</h3>
    <div class="btn-group">
      <button class="btn preset-btn" onclick="applyPreset('edge-test-1')" style="background: #f44336;">å¼±åŒ–é“¶è¾¹</button>
      <button class="btn preset-btn" onclick="applyPreset('edge-test-2')" style="background: #f44336;">æä½é›¾</button>
      <button class="btn preset-btn" onclick="applyPreset('edge-test-3')" style="background: #f44336;">é™ä½åæœŸ</button>
      <button class="btn preset-btn" onclick="applyPreset('edge-test-4')" style="background: #f44336;">é®å¤ªé˜³æµ‹è¯•</button>
    </div>
  </div>

  <div class="controls">
    <div class="control-row">
      <div class="control-group">
        <h4>ğŸŒ«ï¸ é›¾æ•ˆ</h4>
        <div class="slider-container">
          <label>é›¾å¯†åº¦:</label>
          <input type="range" class="slider" id="fogDensity" min="0" max="0.1" step="0.001" value="0.002">
          <span class="value-display" id="fogDensityValue">0.002</span>
        </div>
      </div>
      
      <div class="control-group">
        <h4>â˜ï¸ äº‘å±‚</h4>
        <div class="slider-container">
          <label>äº‘å¯†åº¦:</label>
          <input type="range" class="slider" id="cloudDensity" min="0" max="1" step="0.01" value="0.4">
          <span class="value-display" id="cloudDensityValue">0.4</span>
        </div>
      </div>
      
      <div class="control-group">
        <h4>â˜€ï¸ å…‰ç…§</h4>
        <div class="slider-container">
          <label>æ›å…‰:</label>
          <input type="range" class="slider" id="exposure" min="0.5" max="2" step="0.1" value="1.1">
          <span class="value-display" id="exposureValue">1.1</span>
        </div>
      </div>
    </div>
    
    <div class="control-row">
      <div class="control-group">
        <h4>ğŸ” ç»†èŠ‚</h4>
        <div class="slider-container">
          <label>äº‘é”åˆ©åº¦:</label>
          <input type="range" class="slider" id="cloudSharpness" min="0.1" max="3" step="0.1" value="2.0">
          <span class="value-display" id="cloudSharpnessValue">2.0</span>
        </div>
      </div>
      
      <div class="control-group">
        <h4>ğŸ’¨ é€Ÿåº¦</h4>
        <div class="slider-container">
          <label>äº‘é€Ÿåº¦:</label>
          <input type="range" class="slider" id="cloudSpeed" min="0" max="0.5" step="0.01" value="0.08">
          <span class="value-display" id="cloudSpeedValue">0.08</span>
        </div>
      </div>
      
      <div class="control-group">
        <h4>ğŸŒˆ è¾¹ç¼˜</h4>
        <div class="slider-container">
          <label>é“¶è¾¹:</label>
          <input type="range" class="slider" id="rimLight" min="0" max="3" step="0.1" value="2.5">
          <span class="value-display" id="rimLightValue">2.5</span>
        </div>
      </div>
    </div>
    
    <div class="control-row">
      <div class="btn-group">
        <button class="btn" onclick="toggleAnimation()">â¸ï¸ æš‚åœåŠ¨ç”»</button>
        <button class="btn" onclick="resetParams()">ğŸ”„ é‡ç½®</button>
        <button class="btn" onclick="saveCurrentState()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn" onclick="loadSavedState()">ğŸ“ åŠ è½½</button>
      </div>
    </div>
  </div>

  <div class="status" id="status">
    <div class="status-item"><span class="status-label">æ¸²æŸ“å™¨çŠ¶æ€:</span> <span id="rendererStatus">åˆå§‹åŒ–ä¸­...</span></div>
    <div class="status-item"><span class="status-label">å½“å‰å¤©æ°”:</span> <span id="currentWeather">æœªè®¾ç½®</span></div>
    <div class="status-item"><span class="status-label">åŠ¨ç”»çŠ¶æ€:</span> <span id="animationStatus">è¿è¡Œä¸­</span></div>
    <div class="status-item"><span class="status-label">æ€§èƒ½:</span> <span id="performanceStatus">æ£€æµ‹ä¸­...</span></div>
  </div>

  <div class="log" id="log"></div>
  
  <script src="../three.min.js"></script>
  <script src="advanced-weather-renderer.js"></script>
  <script src="full-weather-engine.js"></script>
  
  <script>
    let renderer = null;
    let weatherEngine = null;
    let animationPaused = false;
    let savedState = null;
    const logDiv = document.getElementById('log');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colorClass = type === 'error' ? 'color: #f44' : type === 'success' ? 'color: #4f4' : type === 'warning' ? 'color: #ff4' : '';
      logDiv.innerHTML += `<span style="${colorClass}">[${timestamp}] ${message}</span><br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type}] ${message}`);
    }
    
    // åˆå§‹åŒ–æ»‘å—äº‹ä»¶
    function initSliders() {
      const sliders = document.querySelectorAll('.slider');
      sliders.forEach(slider => {
        const valueDisplay = document.getElementById(slider.id + 'Value');
        slider.addEventListener('input', function() {
          let value = parseFloat(this.value);
          if (this.id === 'sunAltitude' || this.id === 'sunAzimuth') {
            valueDisplay.textContent = value + 'Â°';
          } else {
            valueDisplay.textContent = value;
          }
          updateWeatherParams();
        });
      });
    }
    
    // æ›´æ–°å¤©æ°”å‚æ•°
    function updateWeatherParams() {
      if (!weatherEngine || !weatherEngine.renderer) return;
      
      const params = {
        fogDensity: parseFloat(document.getElementById('fogDensity').value),
        cloudOpacity: parseFloat(document.getElementById('cloudDensity').value),
        cloudSpeed: parseFloat(document.getElementById('cloudSpeed').value),
        sunAltitude: parseFloat(document.getElementById('sunAltitude')?.value || 45),
        sunAzimuth: parseFloat(document.getElementById('sunAzimuth')?.value || 180),
        exposure: parseFloat(document.getElementById('exposure').value),
        rimLight: parseFloat(document.getElementById('rimLight').value),
        cloudSharpness: parseFloat(document.getElementById('cloudSharpness').value)
      };
      
      weatherEngine.renderer.updateParams(params);
      log(`å‚æ•°å·²æ›´æ–°: é›¾${params.fogDensity.toFixed(3)}, äº‘${params.cloudOpacity.toFixed(2)}`);
    }
    
    // åº”ç”¨é¢„è®¾
    function applyPreset(presetName) {
      log(`åº”ç”¨é¢„è®¾: ${presetName}`, 'success');
      
      const presets = {
        'ios-clear': {
          fogDensity: 0.001,
          cloudDensity: 0.25,
          cloudSpeed: 0.06,
          cloudSharpness: 2.0,
          exposure: 1.1,
          rimLight: 2.5
        },
        'ios-cloudy': {
          fogDensity: 0.002,
          cloudDensity: 0.55,
          cloudSpeed: 0.08,
          cloudSharpness: 2.2,
          exposure: 1.0,
          rimLight: 2.8
        },
        'ios-rain': {
          fogDensity: 0.004,
          cloudDensity: 0.92,
          cloudSpeed: 0.11,
          cloudSharpness: 2.5,
          exposure: 0.92,
          rimLight: 2.2
        },
        'ios-snow': {
          fogDensity: 0.003,
          cloudDensity: 0.88,
          cloudSpeed: 0.06,
          cloudSharpness: 2.3,
          exposure: 0.98,
          rimLight: 2.4
        },
        'low-fog': {
          fogDensity: 0.001,
          cloudDensity: 0.4,
          cloudSpeed: 0.08,
          cloudSharpness: 2.0,
          exposure: 1.1,
          rimLight: 2.5
        },
        'high-detail': {
          fogDensity: 0.002,
          cloudDensity: 0.5,
          cloudSpeed: 0.1,
          cloudSharpness: 3.0,
          exposure: 1.2,
          rimLight: 3.0
        },
        // è¾¹ç¼˜å‡è±¡éªŒè¯æµ‹è¯•é¢„è®¾
        'edge-test-1': {
          fogDensity: 0.002,
          cloudDensity: 0.4,
          cloudSpeed: 0.08,
          cloudSharpness: 1.2,  // é™ä½é”åˆ©åº¦
          exposure: 1.0,
          rimLight: 0.6  // å¤§å¹…å¼±åŒ–é“¶è¾¹
        },
        'edge-test-2': {
          fogDensity: 0.001,  // æä½é›¾
          cloudDensity: 0.4,
          cloudSpeed: 0.08,
          cloudSharpness: 1.5,
          exposure: 1.0,
          rimLight: 1.0
        },
        'edge-test-3': {
          fogDensity: 0.002,
          cloudDensity: 0.4,
          cloudSpeed: 0.08,
          cloudSharpness: 1.3,
          exposure: 0.9,  // é™ä½æ›å…‰
          rimLight: 1.2
        },
        'edge-test-4': {
          fogDensity: 0.003,
          cloudDensity: 0.85,  // é«˜å¯†åº¦äº‘é®æŒ¡å¤ªé˜³
          cloudSpeed: 0.1,
          cloudSharpness: 1.5,
          exposure: 0.95,
          rimLight: 1.5
        }
      };
      
      const preset = presets[presetName];
      if (preset) {
        Object.keys(preset).forEach(key => {
          const slider = document.getElementById(key);
          const valueDisplay = document.getElementById(key + 'Value');
          if (slider) {
            slider.value = preset[key];
            if (valueDisplay) {
              if (key === 'sunAltitude' || key === 'sunAzimuth') {
                valueDisplay.textContent = preset[key] + 'Â°';
              } else {
                valueDisplay.textContent = preset[key];
              }
            }
          }
        });
        
        updateWeatherParams();
        
        // è®¾ç½®å¯¹åº”çš„å¤©æ°”ç±»å‹
        const weatherMap = {
          'ios-clear': 'clear',
          'ios-cloudy': 'cloudy',
          'ios-rain': 'rain',
          'ios-snow': 'snow'
        };
        
        if (weatherMap[presetName] && weatherEngine) {
          weatherEngine.controlParams.weatherType = weatherMap[presetName];
          weatherEngine.updateWeatherType();
        }
      }
    }
    
    // åˆ‡æ¢åŠ¨ç”»
    function toggleAnimation() {
      animationPaused = !animationPaused;
      document.getElementById('animationStatus').textContent = animationPaused ? 'å·²æš‚åœ' : 'è¿è¡Œä¸­';
      log(`åŠ¨ç”»${animationPaused ? 'å·²æš‚åœ' : 'å·²ç»§ç»­'}`, 'warning');
    }
    
    // é‡ç½®å‚æ•°
    function resetParams() {
      log('é‡ç½®æ‰€æœ‰å‚æ•°åˆ°é»˜è®¤å€¼', 'warning');
      applyPreset('ios-clear');
    }
    
    // ä¿å­˜å½“å‰çŠ¶æ€
    function saveCurrentState() {
      const sliders = document.querySelectorAll('.slider');
      savedState = {};
      sliders.forEach(slider => {
        savedState[slider.id] = slider.value;
      });
      log('å½“å‰çŠ¶æ€å·²ä¿å­˜', 'success');
    }
    
    // åŠ è½½ä¿å­˜çš„çŠ¶æ€
    function loadSavedState() {
      if (savedState) {
        Object.keys(savedState).forEach(key => {
          const slider = document.getElementById(key);
          const valueDisplay = document.getElementById(key + 'Value');
          if (slider) {
            slider.value = savedState[key];
            if (valueDisplay) {
              if (key === 'sunAltitude' || key === 'sunAzimuth') {
                valueDisplay.textContent = savedState[key] + 'Â°';
              } else {
                valueDisplay.textContent = savedState[key];
              }
            }
          }
        });
        updateWeatherParams();
        log('å·²åŠ è½½ä¿å­˜çš„çŠ¶æ€', 'success');
      } else {
        log('æ²¡æœ‰ä¿å­˜çš„çŠ¶æ€', 'warning');
      }
    }
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus() {
      if (weatherEngine && weatherEngine.getEngineState) {
        const state = weatherEngine.getEngineState();
        document.getElementById('rendererStatus').textContent = 
          state.initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
        document.getElementById('currentWeather').textContent = 
          state.currentTemplate || 'æœªçŸ¥';
      }
      
      // æ€§èƒ½ç›‘æ§
      if (window.performance && window.performance.memory) {
        const memory = window.performance.memory;
        document.getElementById('performanceStatus').textContent = 
          `å†…å­˜: ${(memory.usedJSHeapSize / 1048576).toFixed(1)}MB`;
      }
    }
    
    async function init() {
      try {
        log('=== å¼€å§‹åˆå§‹åŒ–A/Bæµ‹è¯•ç³»ç»Ÿ ===', 'info');
        
        // åˆå§‹åŒ–æ»‘å—
        initSliders();
        log('âœ… æ»‘å—æ§ä»¶å·²åˆå§‹åŒ–', 'success');
        
        // åˆ›å»ºå¤©æ°”å¼•æ“
        const container = document.getElementById('test-container');
        weatherEngine = new FullWeatherEngine(container);
        
        await weatherEngine.initializationPromise;
        log('âœ… å¤©æ°”å¼•æ“åˆå§‹åŒ–æˆåŠŸ', 'success');
        
        // åº”ç”¨iOSæ™´å¤©é¢„è®¾
        applyPreset('ios-clear');
        log('âœ… å·²åº”ç”¨iOSæ™´å¤©é¢„è®¾', 'success');
        
        // å®šæœŸæ›´æ–°çŠ¶æ€
        setInterval(updateStatus, 1000);
        log('âœ… çŠ¶æ€ç›‘æ§å·²å¯åŠ¨', 'success');
        
        log('ğŸ‰ A/Bæµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼', 'success');
        log('ğŸ’¡ æç¤ºï¼šå°è¯•ä¸åŒçš„é¢„è®¾å’Œå‚æ•°ç»„åˆï¼Œè§‚å¯ŸiOSå¤©æ°”æ•ˆæœ', 'info');
        
      } catch (error) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', init);
  </script>
</body>
</html>