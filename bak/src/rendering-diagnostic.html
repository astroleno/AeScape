<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¸²æŸ“è¯Šæ–­å·¥å…·</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }
    .diagnostic-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .test-button:hover {
      background: #0056b3;
    }
    #weather-container {
      width: 800px;
      height: 600px;
      border: 2px solid #ccc;
      margin: 20px 0;
      border-radius: 8px;
      background: #000;
    }
    #diagnostic-output {
      background: #1e1e1e;
      color: #fff;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-ok { background: #28a745; }
    .status-error { background: #dc3545; }
    .status-warning { background: #ffc107; }
  </style>
</head>
<body>
  <h1>ğŸ”§ æ¸²æŸ“è¯Šæ–­å·¥å…·</h1>
  
  <div class="diagnostic-container">
    <h2>è¯Šæ–­æ§åˆ¶</h2>
    <button class="test-button" onclick="initEngine()">åˆå§‹åŒ–å¼•æ“</button>
    <button class="test-button" onclick="runFullDiagnostic()">å®Œæ•´è¯Šæ–­</button>
    <button class="test-button" onclick="testRendering()">æµ‹è¯•æ¸²æŸ“</button>
    <button class="test-button" onclick="forceRenderUpdate()">å¼ºåˆ¶æ¸²æŸ“æ›´æ–°</button>
    <button class="test-button" onclick="clearOutput()">æ¸…é™¤è¾“å‡º</button>
  </div>
  
  <div id="weather-container"></div>
  
  <div class="diagnostic-container">
    <h2>å®æ—¶æµ‹è¯•æ§åˆ¶</h2>
    <div style="margin: 10px 0;">
      <label>å¤ªé˜³é«˜åº¦è§’: </label>
      <input type="range" id="sun-altitude" min="-90" max="90" value="30" step="1" style="width: 200px;">
      <span id="sun-altitude-value">30Â°</span>
    </div>
    <div style="margin: 10px 0;">
      <label>äº‘é€æ˜åº¦: </label>
      <input type="range" id="cloud-opacity" min="0" max="1" value="0.4" step="0.01" style="width: 200px;">
      <span id="cloud-opacity-value">0.40</span>
    </div>
    <div style="margin: 10px 0;">
      <label>é›¾æµ“åº¦: </label>
      <input type="range" id="fog-density" min="0" max="0.2" value="0.03" step="0.001" style="width: 200px;">
      <span id="fog-density-value">0.030</span>
    </div>
  </div>
  
  <div class="diagnostic-container">
    <h2>è¯Šæ–­è¾“å‡º</h2>
    <div id="diagnostic-output">ç­‰å¾…è¯Šæ–­...</div>
  </div>
  
  <script src="../three.min.js"></script>
  <script src="full-weather-engine.js"></script>
  <script>
    let weatherEngine;
    const diagnosticOutput = document.getElementById('diagnostic-output');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const indicator = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'âœ…';
      diagnosticOutput.textContent += `[${timestamp}] ${indicator} ${message}\n`;
      diagnosticOutput.scrollTop = diagnosticOutput.scrollHeight;
      console.log(message);
    }
    
    function clearOutput() {
      diagnosticOutput.textContent = '';
    }
    
    async function initEngine() {
      clearOutput();
      log('=== åˆå§‹åŒ–å¤©æ°”å¼•æ“ ===');
      
      try {
        const container = document.getElementById('weather-container');
        weatherEngine = new FullWeatherEngine(container);
        
        // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
        await weatherEngine.initializationPromise;
        
        log('âœ… å¤©æ°”å¼•æ“åˆå§‹åŒ–å®Œæˆ');
        
        // æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.engine = weatherEngine;
        window.THREE = THREE;
        
        // è®¾ç½®æ»‘åŠ¨æ¡ç›‘å¬å™¨
        setupSliderListeners();
        
        log('âœ… å¼•æ“å·²æ·»åŠ åˆ° window.engineï¼Œå¯åœ¨æ§åˆ¶å°è®¿é—®');
        
      } catch (error) {
        log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        console.error(error);
      }
    }
    
    function setupSliderListeners() {
      // å¤ªé˜³é«˜åº¦è§’
      const altitudeSlider = document.getElementById('sun-altitude');
      altitudeSlider.oninput = function() {
        const value = parseFloat(this.value);
        document.getElementById('sun-altitude-value').textContent = value + 'Â°';
        
        log(`å¤ªé˜³é«˜åº¦è§’: ${value}Â°`);
        testParameterChange('sunAltitude', value);
      };
      
      // äº‘é€æ˜åº¦
      const opacitySlider = document.getElementById('cloud-opacity');
      opacitySlider.oninput = function() {
        const value = parseFloat(this.value);
        document.getElementById('cloud-opacity-value').textContent = value.toFixed(2);
        
        log(`äº‘é€æ˜åº¦: ${value}`);
        testParameterChange('cloudOpacity', value);
      };
      
      // é›¾æµ“åº¦
      const fogSlider = document.getElementById('fog-density');
      fogSlider.oninput = function() {
        const value = parseFloat(this.value);
        document.getElementById('fog-density-value').textContent = value.toFixed(3);
        
        log(`é›¾æµ“åº¦: ${value}`);
        testParameterChange('fogDensity', value);
      };
    }
    
    function testParameterChange(param, value) {
      if (!weatherEngine || !weatherEngine.controlParams) {
        log('âŒ å¼•æ“æœªåˆå§‹åŒ–', 'error');
        return;
      }
      
      try {
        const oldValue = weatherEngine.controlParams[param];
        weatherEngine.controlParams[param] = value;
        
        log(`å‚æ•° ${param}: ${oldValue} â†’ ${value}`);
        
        // è®°å½•è°ƒç”¨å‰çŠ¶æ€
        log('è°ƒç”¨ applyControlParams å‰...');
        
        weatherEngine.applyControlParams();
        
        log('âœ… applyControlParams è°ƒç”¨å®Œæˆ');
        
        // æ£€æŸ¥æ¸²æŸ“çŠ¶æ€
        setTimeout(() => {
          checkRenderingStatus();
        }, 100);
        
      } catch (error) {
        log(`âŒ å‚æ•°æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }
    
    function checkRenderingStatus() {
      if (!weatherEngine) return;
      
      log('=== æ¸²æŸ“çŠ¶æ€æ£€æŸ¥ ===');
      
      // æ£€æŸ¥å…³é”®å¯¹è±¡
      log(`åœºæ™¯: ${!!weatherEngine.scene}`);
      log(`ç›¸æœº: ${!!weatherEngine.camera}`);
      log(`æ¸²æŸ“å™¨: ${!!weatherEngine.renderer}`);
      log(`å¤©ç©ºçƒ: ${!!weatherEngine.skySphere}`);
      log(`æ–¹å‘å…‰: ${!!weatherEngine.directionalLight}`);
      log(`ç¯å¢ƒå…‰: ${!!weatherEngine.ambientLight}`);
      log(`äº‘ç»„: ${!!weatherEngine.cloudGroup}`);
      
      // æ£€æŸ¥æè´¨å±æ€§
      if (weatherEngine.skySphere && weatherEngine.skySphere.material) {
        const mat = weatherEngine.skySphere.material;
        log(`å¤©ç©ºçƒé¢œè‰²: #${mat.color.getHexString()}`);
        log(`å¤©ç©ºçƒé€æ˜åº¦: ${mat.opacity}`);
      }
      
      if (weatherEngine.directionalLight) {
        log(`æ–¹å‘å…‰å¼ºåº¦: ${weatherEngine.directionalLight.intensity}`);
        log(`æ–¹å‘å…‰é¢œè‰²: #${weatherEngine.directionalLight.color.getHexString()}`);
        log(`æ–¹å‘å…‰ä½ç½®: (${weatherEngine.directionalLight.position.x.toFixed(1)}, ${weatherEngine.directionalLight.position.y.toFixed(1)}, ${weatherEngine.directionalLight.position.z.toFixed(1)})`);
      }
      
      if (weatherEngine.ambientLight) {
        log(`ç¯å¢ƒå…‰å¼ºåº¦: ${weatherEngine.ambientLight.intensity}`);
        log(`ç¯å¢ƒå…‰é¢œè‰²: #${weatherEngine.ambientLight.color.getHexString()}`);
      }
      
      if (weatherEngine.scene && weatherEngine.scene.fog) {
        log(`é›¾æµ“åº¦: ${weatherEngine.scene.fog.density}`);
      }
      
      if (weatherEngine.cloud1 && weatherEngine.cloud1.material) {
        log(`äº‘1é€æ˜åº¦: ${weatherEngine.cloud1.material.opacity}`);
      }
      
      if (weatherEngine.cloud2 && weatherEngine.cloud2.material) {
        log(`äº‘2é€æ˜åº¦: ${weatherEngine.cloud2.material.opacity}`);
      }
    }
    
    function runFullDiagnostic() {
      clearOutput();
      log('=== å®Œæ•´è¯Šæ–­å¼€å§‹ ===');
      
      if (!weatherEngine) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ–å¼•æ“', 'error');
        return;
      }
      
      // 1. æ£€æŸ¥å¼•æ“åŸºç¡€ç»“æ„
      log('1. æ£€æŸ¥å¼•æ“åŸºç¡€ç»“æ„...');
      log(`   å®¹å™¨: ${!!weatherEngine.container}`);
      log(`   æ§åˆ¶å‚æ•°: ${!!weatherEngine.controlParams}`);
      log(`   åˆå§‹åŒ–Promise: ${!!weatherEngine.initializationPromise}`);
      
      // 2. æ£€æŸ¥Three.jsæ ¸å¿ƒå¯¹è±¡
      log('2. æ£€æŸ¥Three.jsæ ¸å¿ƒå¯¹è±¡...');
      log(`   åœºæ™¯: ${!!weatherEngine.scene}`);
      log(`   ç›¸æœº: ${!!weatherEngine.camera}`);
      log(`   æ¸²æŸ“å™¨: ${!!weatherEngine.renderer}`);
      log(`   åˆæˆå™¨: ${!!weatherEngine.composer}`);
      
      // 3. æ£€æŸ¥å…‰æº
      log('3. æ£€æŸ¥å…‰æº...');
      log(`   ç¯å¢ƒå…‰: ${!!weatherEngine.ambientLight}`);
      log(`   æ–¹å‘å…‰: ${!!weatherEngine.directionalLight}`);
      log(`   é—ªç”µå…‰: ${!!weatherEngine.lightningLight}`);
      
      // 4. æ£€æŸ¥å¤©ç©ºå’Œäº‘
      log('4. æ£€æŸ¥å¤©ç©ºå’Œäº‘...');
      log(`   å¤©ç©ºçƒ: ${!!weatherEngine.skySphere}`);
      log(`   äº‘ç»„: ${!!weatherEngine.cloudGroup}`);
      log(`   äº‘1: ${!!weatherEngine.cloud1}`);
      log(`   äº‘2: ${!!weatherEngine.cloud2}`);
      
      // 5. æ£€æŸ¥æ–¹æ³•å¯ç”¨æ€§
      log('5. æ£€æŸ¥æ–¹æ³•å¯ç”¨æ€§...');
      const methods = ['applyControlParams', 'updateSunPosition', 'updateSkyColor', 'updateWeatherType'];
      methods.forEach(method => {
        log(`   ${method}: ${typeof weatherEngine[method]}`);
      });
      
      // 6. æ£€æŸ¥å½“å‰å‚æ•°å€¼
      log('6. æ£€æŸ¥å½“å‰å‚æ•°å€¼...');
      if (weatherEngine.controlParams) {
        Object.keys(weatherEngine.controlParams).forEach(key => {
          log(`   ${key}: ${weatherEngine.controlParams[key]}`);
        });
      }
      
      log('âœ… å®Œæ•´è¯Šæ–­å®Œæˆ');
    }
    
    function testRendering() {
      clearOutput();
      log('=== æµ‹è¯•æ¸²æŸ“åŠŸèƒ½ ===');
      
      if (!weatherEngine) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ–å¼•æ“', 'error');
        return;
      }
      
      try {
        // æµ‹è¯•1: å¼ºåˆ¶æ›´æ–°å¤ªé˜³ä½ç½®
        log('æµ‹è¯•1: å¼ºåˆ¶æ›´æ–°å¤ªé˜³ä½ç½®');
        weatherEngine.controlParams.sunAltitude = 60;
        weatherEngine.controlParams.sunAzimuth = 90;
        weatherEngine.updateSunPosition();
        
        // æµ‹è¯•2: å¼ºåˆ¶æ›´æ–°å¤©ç©ºé¢œè‰²
        log('æµ‹è¯•2: å¼ºåˆ¶æ›´æ–°å¤©ç©ºé¢œè‰²');
        weatherEngine.controlParams.timeOfDayHours = 15;
        weatherEngine.updateSkyColor();
        
        // æµ‹è¯•3: å¼ºåˆ¶åº”ç”¨æ‰€æœ‰å‚æ•°
        log('æµ‹è¯•3: å¼ºåˆ¶åº”ç”¨æ‰€æœ‰å‚æ•°');
        weatherEngine.applyControlParams();
        
        // æµ‹è¯•4: æ‰‹åŠ¨è§¦å‘æ¸²æŸ“
        log('æµ‹è¯•4: æ‰‹åŠ¨è§¦å‘æ¸²æŸ“');
        if (weatherEngine.renderer && weatherEngine.scene && weatherEngine.camera) {
          weatherEngine.renderer.render(weatherEngine.scene, weatherEngine.camera);
          log('âœ… æ‰‹åŠ¨æ¸²æŸ“å®Œæˆ');
        } else {
          log('âŒ æ¸²æŸ“æ‰€éœ€å¯¹è±¡ä¸å®Œæ•´', 'error');
        }
        
        log('âœ… æ¸²æŸ“æµ‹è¯•å®Œæˆ');
        
      } catch (error) {
        log(`âŒ æ¸²æŸ“æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }
    
    function forceRenderUpdate() {
      log('=== å¼ºåˆ¶æ¸²æŸ“æ›´æ–° ===');
      
      if (!weatherEngine) {
        log('âŒ è¯·å…ˆåˆå§‹åŒ–å¼•æ“', 'error');
        return;
      }
      
      try {
        // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æè´¨
        if (weatherEngine.skySphere && weatherEngine.skySphere.material) {
          weatherEngine.skySphere.material.needsUpdate = true;
          log('âœ… å¤©ç©ºçƒæè´¨æ ‡è®°ä¸ºéœ€è¦æ›´æ–°');
        }
        
        if (weatherEngine.directionalLight) {
          weatherEngine.directionalLight.needsUpdate = true;
          log('âœ… æ–¹å‘å…‰æ ‡è®°ä¸ºéœ€è¦æ›´æ–°');
        }
        
        if (weatherEngine.ambientLight) {
          weatherEngine.ambientLight.needsUpdate = true;
          log('âœ… ç¯å¢ƒå…‰æ ‡è®°ä¸ºéœ€è¦æ›´æ–°');
        }
        
        // å¼ºåˆ¶é‡æ–°æ¸²æŸ“
        if (weatherEngine.composer) {
          weatherEngine.composer.render();
          log('âœ… åˆæˆå™¨é‡æ–°æ¸²æŸ“');
        }
        
        // å†æ¬¡æ‰‹åŠ¨æ¸²æŸ“
        if (weatherEngine.renderer && weatherEngine.scene && weatherEngine.camera) {
          weatherEngine.renderer.render(weatherEngine.scene, weatherEngine.camera);
          log('âœ… æ¸²æŸ“å™¨é‡æ–°æ¸²æŸ“');
        }
        
        log('âœ… å¼ºåˆ¶æ¸²æŸ“æ›´æ–°å®Œæˆ');
        
      } catch (error) {
        log(`âŒ å¼ºåˆ¶æ¸²æŸ“æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('load', () => {
      log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»"åˆå§‹åŒ–å¼•æ“"å¼€å§‹è¯Šæ–­');
    });
  </script>
</body>
</html>